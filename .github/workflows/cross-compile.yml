name: Cross-Compile (Linux)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  cross-compile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Extract CEF version for cache key
        id: cef-version
        run: |
          version=$(grep 'set(CEF_VERSION ' cmake/DownloadCEF.cmake | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Cache CEF distribution
        id: cache-cef
        uses: actions/cache@v4
        with:
          path: third_party/cef/cef_dist
          key: cef-${{ steps.cef-version.outputs.version }}-windows64

      - name: Cache Docker image
        id: cache-docker
        uses: actions/cache@v4
        with:
          path: /tmp/docker-image.tar
          key: docker-madduci-wine-msvc-17.8-2022

      - name: Load or pull Docker image
        run: |
          if [ -f /tmp/docker-image.tar ]; then
            echo "Loading Docker image from cache..."
            docker load < /tmp/docker-image.tar
          else
            echo "Pulling Docker image..."
            docker pull madduci/docker-wine-msvc:17.8-2022
            echo "Saving Docker image to cache..."
            docker save madduci/docker-wine-msvc:17.8-2022 -o /tmp/docker-image.tar
          fi

      - name: Build with Docker (Wine + MSVC)
        run: |
          # Make build directory world-writable so the Docker wine user (different
          # UID than the host runner) can create subdirectories and write files on
          # the bind-mounted volume
          mkdir -p "${{ github.workspace }}/build"
          chmod 777 "${{ github.workspace }}/build"

          docker run --rm \
            --platform linux/amd64 \
            -v "${{ github.workspace }}:/project" \
            --entrypoint /bin/bash \
            madduci/docker-wine-msvc:17.8-2022 \
            -c '
              set -e

              echo "=== Step 1: CMake Configure ==="
              cat > /home/wine/.wine/drive_c/configure.bat << "BATEOF"
          @echo off
          call C:\x64.bat
          cmake.exe -G Ninja -B Z:\project\build -S Z:\project -DCMAKE_BUILD_TYPE=Release
          BATEOF
              wine64 cmd /c C:\\configure.bat

              echo ""
              echo "=== Step 2: Fix Wine/Rosetta null-byte corruption ==="
              find /project/build -name "*.ninja" -exec sed -i "s/\x00//g" {} +

              echo ""
              echo "=== Step 3: Generate compile database ==="
              cat > /home/wine/.wine/drive_c/compdb.bat << "BATEOF"
          @echo off
          call C:\x64.bat
          cd /d Z:\project\build
          C:\Tools\Ninja\ninja.exe -t compdb > C:\compdb.json
          BATEOF
              wine64 cmd /c C:\\compdb.bat

              echo ""
              echo "=== Step 4: Build using wine_build.py ==="
              python3 /project/docker/wine_build.py -j4
            '

      - name: Verify build outputs
        run: |
          echo "=== Build outputs ==="
          ls -lh build/nexus_js_loader.dll
          ls -lh build/nexus_js_subprocess.exe

      - name: Collect artifacts
        run: |
          mkdir -p dist/nexus_js_loader/locales
          cp build/nexus_js_loader.dll dist/
          cp build/nexus_js_subprocess.exe dist/nexus_js_loader/
          # CEF core DLLs
          CEF=third_party/cef/cef_dist
          for f in libcef.dll chrome_elf.dll v8_context_snapshot.bin \
                   d3dcompiler_47.dll libEGL.dll libGLESv2.dll \
                   vk_swiftshader.dll vulkan-1.dll dxcompiler.dll dxil.dll; do
            [ -f "$CEF/Release/$f" ] && cp "$CEF/Release/$f" dist/nexus_js_loader/
          done
          [ -f "$CEF/Release/vk_swiftshader_icd.json" ] && \
            cp "$CEF/Release/vk_swiftshader_icd.json" dist/nexus_js_loader/
          # CEF resources
          for f in icudtl.dat chrome_100_percent.pak chrome_200_percent.pak resources.pak; do
            cp "$CEF/Resources/$f" dist/nexus_js_loader/
          done
          cp -r "$CEF/Resources/locales/"* dist/nexus_js_loader/locales/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nexus-js-loader-cross
          path: dist/

