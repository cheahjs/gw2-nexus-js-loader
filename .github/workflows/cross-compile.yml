name: Cross-Compile (Linux)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  cross-compile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Extract CEF version for cache key
        id: cef-version
        run: |
          version=$(grep 'set(CEF_VERSION ' cmake/DownloadCEF.cmake | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Cache CEF distribution
        id: cache-cef
        uses: actions/cache@v4
        with:
          path: third_party/cef/cef_dist
          key: cef-${{ steps.cef-version.outputs.version }}-windows64

      - name: Cache Docker image
        id: cache-docker
        uses: actions/cache@v4
        with:
          path: /tmp/docker-image.tar
          key: docker-madduci-wine-msvc-17.8-2022

      - name: Load or pull Docker image
        run: |
          if [ -f /tmp/docker-image.tar ]; then
            echo "Loading Docker image from cache..."
            docker load < /tmp/docker-image.tar
          else
            echo "Pulling Docker image..."
            docker pull madduci/docker-wine-msvc:17.8-2022
            echo "Saving Docker image to cache..."
            docker save madduci/docker-wine-msvc:17.8-2022 -o /tmp/docker-image.tar
          fi

      - name: Build with Docker (Wine + MSVC)
        run: |
          # Pre-create build directory structure from host to work around
          # Wine/CMake inability to create directories on bind-mounted volumes
          mkdir -p "${{ github.workspace }}/build/CMakeFiles/pkgRedirects"

          docker run --rm \
            --platform linux/amd64 \
            -v "${{ github.workspace }}:/project" \
            --entrypoint /bin/bash \
            madduci/docker-wine-msvc:17.8-2022 \
            -c '
              set -e

              echo "=== Step 1: CMake Configure ==="
              cat > /home/wine/.wine/drive_c/configure.bat << "BATEOF"
          @echo off
          call C:\x64.bat
          cmake.exe -G Ninja -B Z:\project\build -S Z:\project -DCMAKE_BUILD_TYPE=Release
          BATEOF
              wine64 cmd /c C:\\configure.bat

              echo ""
              echo "=== Step 2: Fix Wine/Rosetta null-byte corruption ==="
              find /project/build -name "*.ninja" -exec sed -i "s/\x00//g" {} +

              echo ""
              echo "=== Step 3: Generate compile database ==="
              cat > /home/wine/.wine/drive_c/compdb.bat << "BATEOF"
          @echo off
          call C:\x64.bat
          cd /d Z:\project\build
          C:\Tools\Ninja\ninja.exe -t compdb > C:\compdb.json
          BATEOF
              wine64 cmd /c C:\\compdb.bat

              echo ""
              echo "=== Step 4: Build using wine_build.py ==="
              python3 /project/docker/wine_build.py
            '

      - name: Verify build outputs
        run: |
          echo "=== Build outputs ==="
          ls -lh build/nexus_js_loader.dll
          ls -lh build/nexus_js_subprocess.exe
          ls -lh build/libcef.dll
